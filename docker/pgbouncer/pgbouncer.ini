; PgBouncer Configuration for OpenTracker
; Connection pooling for high-concurrency PostgreSQL access

[databases]
; Database connection string
; Format: dbname = host=hostname port=port dbname=database
opentracker = host=postgres port=5432 dbname=opentracker

[pgbouncer]
; Listen on all interfaces
listen_addr = 0.0.0.0
listen_port = 6432

; Authentication
; Using plain auth is secure here as pgbouncer is only accessible within Docker network
auth_type = plain
auth_file = /etc/pgbouncer/userlist.txt

; Pool mode: transaction is best for web applications
; - session: connection is returned to pool after client disconnects
; - transaction: connection is returned after each transaction
; - statement: connection is returned after each statement (breaks multi-statement transactions)
pool_mode = transaction

; Pool sizing
; default_pool_size: connections per user/database pair
default_pool_size = 20
min_pool_size = 5
reserve_pool_size = 5
reserve_pool_timeout = 3

; Maximum connections
max_client_conn = 500
max_db_connections = 100

; Timeouts
server_connect_timeout = 15
server_login_retry = 15
server_lifetime = 3600
server_idle_timeout = 600
client_idle_timeout = 0
client_login_timeout = 60
query_timeout = 0
query_wait_timeout = 120

; Logging
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
stats_period = 60

; Admin console
admin_users = tracker
stats_users = tracker

; TCP keepalive
tcp_keepalive = 1
tcp_keepidle = 30
tcp_keepintvl = 10
tcp_keepcnt = 3

; DNS
dns_max_ttl = 15
dns_nxdomain_ttl = 15

; Server reset query for transaction mode
server_reset_query = DISCARD ALL
server_reset_query_always = 0

; TLS (uncomment for production)
; server_tls_sslmode = require
; server_tls_ca_file = /etc/pgbouncer/certs/ca.crt
