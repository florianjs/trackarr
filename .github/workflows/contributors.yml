name: Update Contributors

on:
    push:
        branches: [main]
    workflow_dispatch:

jobs:
    update-contributors:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Generate contributors list
              id: contributors
              run: |
                  # Create a script file to avoid YAML escaping issues
                  cat > /tmp/update-contributors.sh << 'SCRIPT'
                  #!/bin/bash
                  set -e

                  # Generate contributors table rows
                  ROWS=""
                  while IFS= read -r line; do
                    count=$(echo "$line" | awk '{print $1}')
                    name=$(echo "$line" | sed 's/^[[:space:]]*[0-9]*[[:space:]]*//')
                    
                    # Get email to extract GitHub username
                    email=$(git log --author="$name" --format='%ae' | head -1)
                    
                    # Skip the project creator
                    if echo "$email" | grep -qi "florianjs"; then
                      continue
                    fi
                    
                    # Extract username from email
                    if echo "$email" | grep -q "noreply.github.com"; then
                      username=$(echo "$email" | sed 's/@.*//' | sed 's/.*+//')
                    else
                      username=$(echo "$email" | sed 's/@.*//')
                    fi
                    
                    ROWS="${ROWS}| <img src=\"https://github.com/${username}.png\" width=\"40\" height=\"40\" style=\"border-radius:50%\"> | **[$name](https://github.com/${username})** | ${count} |\n"
                  done < <(git shortlog -sn --all)

                  # Create temp file with new content
                  cat > /tmp/contributors-section.md << EOF
                  <!-- CONTRIBUTORS:START -->
                  ## ðŸ‘¥ Contributors

                  Thanks to all our contributors! Sorted by number of commits.

                  | Avatar | Contributor | Commits |
                  |:------:|-------------|:-------:|
                  $(echo -e "$ROWS")<!-- CONTRIBUTORS:END -->
                  EOF

                  # Remove leading spaces from heredoc
                  sed -i 's/^          //' /tmp/contributors-section.md

                  # Remove old section if exists
                  if grep -q "<!-- CONTRIBUTORS:START -->" README.md; then
                    sed '/<!-- CONTRIBUTORS:START -->/,/<!-- CONTRIBUTORS:END -->/d' README.md > /tmp/readme-clean.md
                    mv /tmp/readme-clean.md README.md
                  fi

                  # Insert new section before License
                  awk '/^## ðŸ“„ License/ { 
                    while ((getline line < "/tmp/contributors-section.md") > 0) print line
                    print ""
                    print "---"
                    print ""
                  } {print}' README.md > /tmp/readme-new.md
                  mv /tmp/readme-new.md README.md
                  SCRIPT

                  chmod +x /tmp/update-contributors.sh
                  /tmp/update-contributors.sh

            - name: Commit changes
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"
                  if ! git diff --quiet README.md; then
                    git add README.md
                    git commit -m "docs: update contributors list [skip ci]"
                    git push
                  fi
